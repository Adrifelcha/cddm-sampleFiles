---
title: "Circular Drift Difussion Model on JAGS: Full example"
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: "left=1.25cm,right=1.25cm,top=1.25cm,bottom=1.25cm"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Generate/load simulated data

```{r, warning=FALSE, fig.width=10,fig.height=6, fig.align='center'}
# Establish no. of trials
trials <- 350
# Call Rscript to generate simulated data / load it  if already existing
source("./getData.R")
head(data)
# Plot data
cddm.plotData(data)
```

```{r}
# Print parameter values used to generate this data
par
```

\clearpage

# 2. Write JAGS model

```{r}
modelFile <- "cddm.bug"
write('
            model{
                  # Likelihood
                    for (i in 1:N) {
                         X[1:2,i] ~ dcddm(drift, bound, ter0, theta0)
                    }
                      
                  # Priors
                    drift  ~ dnorm(0, 0.1)T(0,)
                    theta0 ~ dnorm(0, 0.1)T(-3.14, 3.14)
                    bound  ~ dgamma(3, 2)
                    ter0   ~ dexp(1)T(, tmin)
                  }',
      modelFile)
```


where: 

- `drift` is the magnitude of the drift vector composed by the individual drift rates related to the average motion observed across the x and y axes, according to the CDDM.
- `bound` is the threshold (i.e. the radius of the circle)
- `ter0` is the non-decision time (a.k.a. "time for encoding and response")
- `theta0` is the direction of the drift vector, in radians.

# Prepare Settings to be passed to JAGS

```{r}
n.chains = 4
n.iter = 2500
n.burnin = 500
n.thin = 1
perParticipant = FALSE
perTask = FALSE

sampling.Settings <- list(n.chains,n.iter,n.burnin,n.thin,perParticipant,perTask)
names(sampling.Settings) <- c("n.chains","n.iter","n.burnin","n.thin","perParticipant","perTask")
```

# Run JAGS model

```{r, warning=FALSE, message=FALSE}
# Load Rscript with main function to run jags CDDM model
source("../Functions/runCDDMjags.R")
```

```{r}
samplesFile <- "samples.RData"

if(!file.exists(samplesFile)){ 
         myJAGSsampling.CDDM(sampling.Settings,modelFile,samplesFile,data) 
  }
  
load(file=samplesFile)
  
if(file.exists(samplesFile)){ 
         samples 
  }
```

```{r, warning=FALSE,message=FALSE}
source("../Functions/processJAGSsamples.R")
drift  <- myJAGSsampling.extractSamples("drift",samples)
bound  <- myJAGSsampling.extractSamples("bound",samples)
ter0   <- myJAGSsampling.extractSamples("ter0",samples)
theta0 <- myJAGSsampling.extractSamples("theta0",samples)
```

```{r}
# Get descriptive statistics for posterior samples
###########################################################
map.theta0 <- JAGSoutput.maxDensity(theta0)
map.drift <- JAGSoutput.maxDensity(drift)
map.bound <- JAGSoutput.maxDensity(bound)
map.ter0 <- JAGSoutput.maxDensity(ter0)
MAPS <- c(map.theta0,map.drift,map.bound,map.ter0)
names(MAPS) <- c("map.theta0","map.drift","map.bound","map.ter0")

mean.theta0 <- mean(theta0)
mean.drift <- mean(drift)
mean.bound <- mean(bound)
mean.ter0 <- mean(ter0)
means <- c(mean.theta0,mean.drift,mean.bound,mean.ter0)
names(means) <- c("mean.theta0","mean.drift","mean.bound","mean.ter0")
```

\clearpage

```{r, fig.align='center', fig.height=7.5}
source("../Functions/plotJAGSsamples.R")
par(mfrow = c(3,2))
plot.ShowAllChains(samples)
```

```{r}
source("../Functions/processJAGSsamples.R")
myJAGSsampling.Rhat.max(samples)
```

\clearpage

```{r, fig.align='center',fig.height=7}
par(mfrow = c(2,2))
plot.PosteriorDensity(drift,par["true.drift"])
plot.PosteriorDensity(bound,par["true.bound"])
plot.PosteriorDensity(ter0,par["true.ter0"])
plot.PosteriorDensity(theta0,par["true.theta0"])
```

\clearpage

# Check against EZ-estimates

```{r}
source("../Functions/ezcdm.R")
EZ <- ezcdm.fit(data$Choice,data$RT)

## True parameter values used in simulation
par

## EZ estimates
EZ

# MAPs across parameters
MAPS

# Means across parameters 
means
```